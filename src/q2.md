```js
import {darkModeColors} from "./components/colors.js";
```


```js
const q2data = await FileAttachment("data/q2.csv").csv();

  const margin = { top: 50, right: 200, bottom: 60, left: 70 };
  const width = 900 - margin.left - margin.right;
  const height = 400 - margin.top - margin.bottom;

  const svg = d3.create("svg")
    .attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom);



  const g = svg.append("g")
      .attr("transform", `translate(${margin.left},${margin.top})`);

  g.append("text")
      .attr("x", width / 2)
      .attr("y", -30)
      .attr("text-anchor", "middle")
      .style("font-size", "22px")
      .style("font-weight", "600")
      .style("fill", "#f0f0f0")
      .text("Life Expectancy vs GDP per Capita (1990-2023)");

  const color = d3.scaleOrdinal()
    .domain(["<60%", "60-80%", "80-90%", "90-100%"])
    .range(darkModeColors);

  const xVals = q2data
    .map(d => +d["GDP per capita (current US$)"])
    .filter(Number.isFinite);

  const yVals = q2data
    .map(d => +d["Life expectancy at birth, total (years)"])
    .filter(Number.isFinite);

  const x = d3.scaleLog()
    .domain(d3.extent(xVals))
    .nice()
    .range([0, width]);

  const y = d3.scaleLinear()
    .domain(d3.extent(yVals))
    .nice()
    .range([height, 0]);

  g.append("g")
    .attr("transform", `translate(0,${height})`)
    .call(d3.axisBottom(x).ticks(10, "~s"));

  g.append("g")
    .call(d3.axisLeft(y));

  g.append("text")
    .attr("x", width / 2)
    .attr("y", height + 40)
    .attr("text-anchor", "middle")
    .text("GDP per Capita (USD, log scale)");

  g.append("text")
    .attr("transform", "rotate(-90)")
    .attr("x", -(height / 2))
    .attr("y", -35)
    .attr("text-anchor", "middle")
    .text("Life Expectancy (years)");

  d3.select("body").selectAll(".tooltip").remove();

  const tooltip = d3.select("body")
    .append("div")
      .attr("class", "tooltip")
      .style("position", "absolute")
      .style("background", "white")
      .style("padding", "8px 10px")
      .style("border", "1px solid #ccc")
      .style("border-radius", "4px")
      .style("pointer-events", "none")
      .style("color", "black")
      .style("opacity", 0)
      .style("font-size", "12px");

  g.selectAll("circle")
    .data(q2data)
    .enter()
    .append("circle")
      .attr("cx", d => x(+d["GDP per capita (current US$)"]))
      .attr("cy", d => y(+d["Life expectancy at birth, total (years)"]))
      .attr("r", Math.sqrt(80 / Math.PI))
      .attr("fill", d => color(d.literacy_bucket))
      .attr("opacity", 0.75)
      .on("mouseover", (event, d) => {
        tooltip.style("opacity", 1)
          .html(`
            <b>${d.country_name}</b><br>
            Income Group: ${d.income_group}
          `);
      })
      .on("mousemove", (event) => {
        tooltip
          .style("left", (event.pageX + 15) + "px")
          .style("top", (event.pageY - 28) + "px");
      })
      .on("mouseleave", () => {
        tooltip.style("opacity", 0);
      });

  const legend = g.append("g")
    .attr("transform", `translate(${width + 10}, 10)`);

  legend.append("text")
        .attr("y", -15)
        .attr("font-size", "14px")
        .attr("font-weight", "bold")
        .text("Literacy rate");

  const buckets = color.domain();

  buckets.forEach((bucket, i) => {
    const yOffset = i * 20;

    legend.append("rect")
      .attr("x", 0)
      .attr("y", yOffset)
      .attr("width", 12)
      .attr("height", 12)
      .attr("fill", color(bucket));

    legend.append("text")
      .attr("x", 20)
      .attr("y", yOffset + 10)
      .text(bucket)
      .style("font-size", "12px");
  });

  display(svg.node());

```

The scatterplot (GDP vs. life expectancy) shows a clear upward trend: as GDP per capita increases, countries generally have higher life expectancy. Points also become more dominated by high-literacy categories (80-90% and 90-100%) at higher GDP levels, while low-income countries cluster at the lower end of both axes. This indicates that richer countries tend to have better health and education outcomes.

The faceted charts break the same dataset into four economic tiers (“Low GDP,” “Lower-Mid GDP,” “Upper-Mid GDP,” and “High GDP”), revealing how social indicators vary within each income bracket.

```js
  const facetWidth = 350;
  const facetHeight = 280;
  const margin = { top: 50, right: 30, bottom: 60, left: 70 };
  const legendWidth = 220;

  const tiers = ["Low GDP", "Lower-Mid GDP", "Upper-Mid GDP", "High GDP"];

  const color = d3.scaleOrdinal()
    .domain(["High income", "Low income", "Lower middle income", "Not classified", "Upper middle income"])
    .range(darkModeColors);

  const size = d3.scaleSqrt()
    .domain([40, 90])
    .range([3, 18])
    .clamp(true);

  const wrapper = d3.create("div")
    .attr("class", "facet-wrapper")
    .style("display", "flex")
    .style("gap", "20px")
    .style("flex-wrap", "wrap");

  wrapper.append("div")
    .style("width", "100%")
    .style("text-align", "center")
    .style("margin-bottom", "10px")
    .style("font-size", "22px")
    .style("font-weight", "600")
    .style("color", "#f0f0f0")
    .text("Literacy Rate vs GDP Per Capita (1990-2023)");

  const style = document.createElement("style");
  style.textContent = `
    .facet-wrapper {
      display: flex;
      gap: 20px;
      flex-wrap: wrap;
    }
    .facet-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 20px;
      flex: 1;
      /* min-width: 0 removed to allow proper wrapping when content is too wide */
    }
    .facet-legend-container {
      width: 220px;
      flex-shrink: 0;
    }
    @media (max-width: 1250px) {
      .facet-wrapper {
        flex-direction: column;
      }
      .facet-legend-container {
        width: 100%;
        max-width: 400px;
      }
    }
    @media (max-width: 768px) {
      .facet-grid {
        grid-template-columns: 1fr;
      }
    }
  `;
  document.head.appendChild(style);

  const gridContainer = wrapper.append("div")
    .attr("class", "facet-grid");

  const gdpValues = q2data.map(d => +d["GDP per capita (current US$)"]).filter(d => d > 0);
  const xMin = d3.quantile(gdpValues, 0.02);
  const xMax = d3.quantile(gdpValues, 0.98);

  const xPadding = 20;
  const innerWidth = facetWidth - xPadding * 2;

  const x = d3.scaleLog()
    .domain([xMin, xMax])
    .range([xPadding, facetWidth - xPadding])
    .clamp(true);

  const y = d3.scaleLinear()
    .domain([20, 100])
    .range([facetHeight, 0])
    .nice();

  const xTicks = [500, 1000, 5000, 10000];

  tiers.forEach((tier, index) => {
    const facetDiv = gridContainer.append("div");
    
    const svg = facetDiv.append("svg")
      .attr("width", facetWidth + margin.left + margin.right)
      .attr("height", facetHeight + margin.top + margin.bottom);

    const g = svg.append("g")
      .attr("transform", `translate(${margin.left},${margin.top})`);

    const data = q2data.filter(d => d.gdp_tier === tier);

    g.append("g")
      .attr("class", "grid")
      .attr("transform", `translate(0,${facetHeight})`)
      .call(
        d3.axisBottom(x)
          .tickValues(xTicks)
          .tickFormat("")
          .tickSize(-facetHeight)
      )
      .call(g => {
        g.select(".domain").remove();
        g.selectAll("line").attr("stroke", "#444").attr("stroke-opacity", 0.3);
      });

    g.append("g")
      .attr("class", "grid")
      .call(
        d3.axisLeft(y)
          .tickSize(-innerWidth)
          .tickFormat("")
      )
      .call(g => {
        g.select(".domain").remove();
        g.selectAll("line").attr("stroke", "#444").attr("stroke-opacity", 0.3);
      });

    g.append("g")
      .attr("transform", `translate(0,${facetHeight})`)
      .call(
        d3.axisBottom(x)
          .tickValues(xTicks)
          .tickFormat(d3.format("~s"))
      );

    g.append("g")
      .call(d3.axisLeft(y));

    g.selectAll("circle")
      .data(data)
      .join("circle")
      .attr("cx", d => x(+d["GDP per capita (current US$)"]))
      .attr("cy", d => y(+d["Literacy rate, adult total (% of people ages 15 and above)"]))
      .attr("r", d => size(+d["Life expectancy at birth, total (years)"]))
      .attr("opacity", 0.7)
      .attr("fill", d => color(d.income_group));



    svg.append("text")
      .attr("x", margin.left)
      .attr("y", 30)
      .attr("font-size", "18px")
      .attr("font-weight", "600")
      .style("fill", "#f0f0f0")
      .text(tier);

    if (index >= 2) {
      svg.append("text")
        .attr("x", margin.left + facetWidth / 2)
        .attr("y", facetHeight + margin.top + 45)
        .attr("text-anchor", "middle")
        .attr("font-size", "12px")
        .style("fill", "#e0e0e0")
        .text("GDP per Capita (USD, log)");
    }

    if (index % 2 === 0) {
      svg.append("text")
        .attr("transform", `translate(${margin.left - 55},${margin.top + facetHeight / 2}) rotate(-90)`)
        .attr("text-anchor", "middle")
        .attr("font-size", "12px")
        .style("fill", "#e0e0e0")
        .text("Literacy Rate (%)");
    }
  });

  const legendContainer = wrapper.append("div")
    .attr("class", "facet-legend-container");

  const legend = legendContainer.append("svg")
    .attr("width", legendWidth)
    .attr("height", 600);

  legend.append("text")
    .attr("x", 10)
    .attr("y", 25)
    .attr("font-size", "16px")
    .attr("font-weight", "600")
    .style("fill", "#f0f0f0")
    .text("Income Group");

  ["High income", "Low income", "Lower middle income", "Not classified", "Upper middle income"]
    .forEach((group, i) => {
      legend.append("circle")
        .attr("cx", 15)
        .attr("cy", 55 + i * 28)
        .attr("r", 7)
        .attr("fill", color(group));
      legend.append("text")
        .attr("x", 30)
        .attr("y", 60 + i * 28)
        .attr("font-size", "13px")
        .style("fill", "#e0e0e0")
        .text(group);
    });

  legend.append("text")
    .attr("x", 10)
    .attr("y", 220)
    .attr("font-size", "16px")
    .attr("font-weight", "600")
    .style("fill", "#f0f0f0")
    .text("Life Expectancy");

  [50, 60, 70, 80].forEach((v, i) => {
    legend.append("circle")
      .attr("cx", 25)
      .attr("cy", 250 + i * 40)
      .attr("r", size(v))
      .attr("fill", "#c5e1a5")
      .attr("opacity", 0.5);
    legend.append("text")
      .attr("x", 50)
      .attr("y", 255 + i * 40)
      .attr("font-size", "13px")
      .style("fill", "#e0e0e0")
      .text(v + " years");
  });

  display(wrapper.node());
```
The Low-GDP panel shows large variation in both literacy and life expectancy, and most countries fall into low or lower-middle income groups. The Lower-Mid GDP group shows tighter clustering with moderate literacy and life expectancy. The Upper-Mid GDP panel is dominated by high literacy and high life expectancy. The High-GDP panel is extremely dense near the very top of both scales, with nearly all countries showing >90% literacy and 80-85+ years of life expectancy. Across all panels, circle size (life expectancy) and color (income group) consistently shift upward as GDP increases, visually reinforcing the overall trend.

There is a strong and visible correlation between economic growth and social progress. Countries with higher GDP per capita almost always exhibit higher literacy rates and longer life expectancy. The relationship is monotonic and persistent across all tiers: no high-GDP country has low literacy or low life expectancy, while many low-GDP countries do.

Countries with similar GDP levels do differ in their social outcomes, but less so at higher income levels. In the Low-GDP tier, social progress varies dramatically. Some countries achieve literacy rates above 80% and relatively high life expectancy despite low GDP, while others with the same GDP level lag significantly behind. This suggests that policy, governance, or regional factors play a major role when resources are limited. In the Lower-Mid GDP tier, variation narrows but is still notable. Countries in this range can differ by 20+ percentage points in literacy despite having similar GDP per capita. In the Upper-Mid GDP tier, social outcomes become more uniform.

Most countries reach high literacy rates and life expectancy converges around the upper 70s to low 80s. In the High-GDP tier, differences are almost completely non-existent. Nearly all countries have >90% literacy and long life expectancy, indicating that once GDP crosses a high threshold, social indicators flatten out.
